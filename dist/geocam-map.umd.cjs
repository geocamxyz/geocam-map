(function(w,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(w=typeof globalThis<"u"?globalThis:w||self,v(w.GeocamMap={}))})(this,function(w){"use strict";var v=typeof window<"u";const A={Promise:v?window.Promise:void 0};var U="4.25",F="next";function q(e){if(e.toLowerCase()===F)return F;var t=e&&e.match(/^(\d)\.(\d+)/);return t&&{major:parseInt(t[1],10),minor:parseInt(t[2],10)}}function $(e){return e===void 0&&(e=U),"https://js.arcgis.com/".concat(e,"/")}function R(e){e===void 0&&(e=U);var t=$(e),r=q(e);if(r!==F&&r.major===3){var n=r.minor<=10?"js/":"";return"".concat(t).concat(n,"esri/css/esri.css")}else return"".concat(t,"esri/themes/light/main.css")}function H(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t}function J(e,t){if(t){var r=document.querySelector(t);r.parentNode.insertBefore(e,r)}else document.head.appendChild(e)}function V(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function X(e){return!e||q(e)?R(e):e}function Z(e,t){var r=X(e),n=V(r);return n||(n=H(r),J(n,t)),n}var K={};function O(e){var t=document.createElement("script");return t.type="text/javascript",t.src=e,t.setAttribute("data-esri-loader","loading"),t}function G(e,t,r){var n;r&&(n=Q(e,r));var i=function(){t(e),e.removeEventListener("load",i,!1),n&&e.removeEventListener("error",n,!1)};e.addEventListener("load",i,!1)}function Q(e,t){var r=function(n){t(n.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",r,!1)};return e.addEventListener("error",r,!1),r}function j(){return document.querySelector("script[data-esri-loader]")}function k(){var e=window.require;return e&&e.on}function Y(e){e===void 0&&(e={});var t={};[K,e].forEach(function(i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])});var r=t.version,n=t.url||$(r);return new A.Promise(function(i,o){var d=j();if(d){var y=d.getAttribute("src");y!==n?o(new Error("The ArcGIS API for JavaScript is already loaded (".concat(y,")."))):k()?i(d):G(d,i,o)}else if(k())o(new Error("The ArcGIS API for JavaScript is already loaded."));else{var s=t.css;if(s){var g=s===!0;Z(g?r:s,t.insertCssBefore)}d=O(n),G(d,function(){d.setAttribute("data-esri-loader","loaded"),i(d)},o),document.body.appendChild(d)}})}function B(e){return new A.Promise(function(t,r){var n=window.require.on("error",r);window.require(e,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.remove(),t(i)})})}function _(e,t){if(t===void 0&&(t={}),k())return B(e);var r=j(),n=r&&r.getAttribute("src");return!t.url&&n&&(t.url=n),Y(t).then(function(){return B(e)})}async function ee(e,t){const r={version:"4.26",css:!0};let n;const i=[{name:"Zoom"}],o=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DistanceMeasurement2D",icon:"esri-icon-measure",watchExpandFor:{expanded:(s,g,C,m)=>{m.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(s,g,C,m)=>{s==="measuring"?m.view.emit("clickable",!1):s!=="measuring"&&g==="measuring"&&m.view.emit("clickable",!0),console.log("viewmodel state change",s,m)}}}],d=i?i.map(s=>s.class?s.class:`esri/widgets/${s.name}`):[],y=o?o.map(s=>s.class?s.class:`esri/widgets/${s.name}`):[];return await _(["esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/layers/FeatureLayer"].concat(d).concat(y),r).then(([s,g,C,m,...D])=>{const M=new URLSearchParams(window.location.search),P=M.get("cell"),x=t||M.get("webmapid");let E,S;if(x){const c={id:x};if(x.startsWith("http")){const l=x.split("/");c.id=l.pop();const f=l.join("/"),p=new Portal({url:f});c.portal=p}E=new s({portalItem:c})}else E=new s({basemap:"satellite"});if(P){const c=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${P}/FeatureServer/0`;console.log("shots url is",c),S=new m({url:c,definitionExpression:"mod(id,100) = 0"}),E.add(S);const l=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${P}/FeatureServer/1`;console.log("points features url is",l);const f=new m({url:l,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});E.add(f)}M.get("zoom")||S&&S.when(c=>{const l={xmin:-.005,ymin:-.005,xmax:.005,ymax:.005},f=Object.keys(l),p={};for(let u=0;u<f.length;u++)p[f[u]]=parseFloat(c.fullExtent[f[u]])+l[f[u]];n.extent=p}),n=new g({container:e,map:E,ui:{components:["attribution"]}});const I=document.getElementsByTagName("geocam-viewer-arcgis-map")[0];I&&I.link&&(console.log("map linking to connector",n),I.link(n));const z=function(c){return c.layers.items.map(l=>l.layers?z(l):l)},te=function(c){return z(c).flat()};n.when(async()=>{let c=[],l=!1;const f=te(n.map);for(let u=0;u<f.length;u++){const a=f[u];if(await n.whenLayerView(a),a.editingEnabled&&(l=!0),a.fields){const b=a.fields.map(h=>h.name);c.push({layer:a,searchFields:b})}}const p=[];d.forEach((u,a)=>{const b=D[a],h=new b({view:n,container:document.createElement("div"),...i[a].options});p.push(h)}),y.forEach((u,a)=>{if(u==="esri/widgets/Editor"&&!l)return;u==="esri/widgets/Search"&&(o[a].options=o[a].options||{},o[a].options.sources=o[a].options.sources||c);const b=D[a+d.length],h=new b({view:n,container:document.createElement("div"),...o[a].options});console.log("loaded widget",{view:n,container:document.createElement("div"),...o[a].options});const T=new C({view:n,group:"expands",autoCollapse:!0,content:h,expandIconClass:o[a].icon});o[a].watchWidgetFor&&Object.keys(o[a].watchWidgetFor).forEach(L=>{h.watch(L,(...W)=>o[a].watchWidgetFor[L].apply(h,W))}),o[a].watchExpandFor&&Object.keys(o[a].watchExpandFor).forEach(L=>{T.watch(L,(...W)=>o[a].watchExpandFor[L].apply(T,W))}),p.push(T)}),n.ui.add(p,"top-right"),console.log("All widgets added")})}),n}class N extends HTMLElement{constructor(){super(),console.log("Map init")}connectedCallback(){console.log("Map connected");const t=this,r=t.getAttribute("data-webmapid");ee(t,r)}disconnectedCallback(){console.log("labe disconnected")}}window.customElements.define("geocam-map",N),w.GeocamMap=N,Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});
