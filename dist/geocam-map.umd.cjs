(function(v,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(v=typeof globalThis<"u"?globalThis:v||self,E(v.GeocamMap={}))})(this,function(v){"use strict";var E=typeof window<"u";const G={Promise:E?window.Promise:void 0};var U="4.25",F="next";function q(e){if(e.toLowerCase()===F)return F;var t=e&&e.match(/^(\d)\.(\d+)/);return t&&{major:parseInt(t[1],10),minor:parseInt(t[2],10)}}function R(e){return e===void 0&&(e=U),"https://js.arcgis.com/".concat(e,"/")}function H(e){e===void 0&&(e=U);var t=R(e),a=q(e);if(a!==F&&a.major===3){var n=a.minor<=10?"js/":"";return"".concat(t).concat(n,"esri/css/esri.css")}else return"".concat(t,"esri/themes/light/main.css")}function J(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t}function K(e,t){if(t){var a=document.querySelector(t);a.parentNode.insertBefore(e,a)}else document.head.appendChild(e)}function X(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function Z(e){return!e||q(e)?H(e):e}function _(e,t){var a=Z(e),n=X(a);return n||(n=J(a),K(n,t)),n}var O={};function Q(e){var t=document.createElement("script");return t.type="text/javascript",t.src=e,t.setAttribute("data-esri-loader","loading"),t}function $(e,t,a){var n;a&&(n=Y(e,a));var c=function(){t(e),e.removeEventListener("load",c,!1),n&&e.removeEventListener("error",n,!1)};e.addEventListener("load",c,!1)}function Y(e,t){var a=function(n){t(n.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",a,!1)};return e.addEventListener("error",a,!1),a}function N(){return document.querySelector("script[data-esri-loader]")}function M(){var e=window.require;return e&&e.on}function ee(e){e===void 0&&(e={});var t={};[O,e].forEach(function(c){for(var o in c)Object.prototype.hasOwnProperty.call(c,o)&&(t[o]=c[o])});var a=t.version,n=t.url||R(a);return new G.Promise(function(c,o){var u=N();if(u){var b=u.getAttribute("src");b!==n?o(new Error("The ArcGIS API for JavaScript is already loaded (".concat(b,")."))):M()?c(u):$(u,c,o)}else if(M())o(new Error("The ArcGIS API for JavaScript is already loaded."));else{var r=t.css;if(r){var w=r===!0;_(w?a:r,t.insertCssBefore)}u=Q(n),$(u,function(){u.setAttribute("data-esri-loader","loaded"),c(u)},o),document.body.appendChild(u)}})}function B(e){return new G.Promise(function(t,a){var n=window.require.on("error",a);window.require(e,function(){for(var c=[],o=0;o<arguments.length;o++)c[o]=arguments[o];n.remove(),t(c)})})}function te(e,t){if(t===void 0&&(t={}),M())return B(e);var a=N(),n=a&&a.getAttribute("src");return!t.url&&n&&(t.url=n),ee(t).then(function(){return B(e)})}async function ne(e,t){const a={version:"4.26",css:!0};let n;const c=[{name:"Zoom"}],o=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DistanceMeasurement2D",icon:"esri-icon-measure",watchExpandFor:{expanded:(r,w,L,m)=>{m.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(r,w,L,m)=>{r==="measuring"?m.view.emit("clickable",!1):r!=="measuring"&&w==="measuring"&&m.view.emit("clickable",!0),console.log("viewmodel state change",r,m)}}},{name:"AreaMeasurement2D",icon:"esri-icon-measure-area",watchExpandFor:{expanded:(r,w,L,m)=>{m.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(r,w,L,m)=>{r==="measuring"?m.view.emit("clickable",!1):r!=="measuring"&&w==="measuring"&&m.view.emit("clickable",!0),console.log("viewmodel state change",r,m)}}}],u=c?c.map(r=>r.class?r.class:`esri/widgets/${r.name}`):[],b=o?o.map(r=>r.class?r.class:`esri/widgets/${r.name}`):[];return await te(["esri/identity/IdentityManager","esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/layers/FeatureLayer"].concat(u).concat(b),a).then(([r,w,L,m,j,...z])=>{window.ARCGIS_TOKEN&&r.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const A=new URLSearchParams(window.location.search),I=A.get("cell"),k=t||A.get("webmapid");let y,C;if(k){const s={id:k};if(k.startsWith("http")){const l=k.split("/");s.id=l.pop();const f=l.join("/"),d=new Portal({url:f});s.portal=d}y=new w({portalItem:s})}else y=new w({basemap:"satellite"});if(I){const s=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${I}/FeatureServer/0`;console.log("shots url is",s),C=new j({url:s,definitionExpression:"mod(id,100) = 0"}),y.add(C);const l=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${I}/FeatureServer/1`;console.log("points features url is",l);const f=new j({url:l,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});y.add(f)}A.get("zoom")||C&&C.when(s=>{const l={xmin:-.005,ymin:-.005,xmax:.005,ymax:.005},f=Object.keys(l),d={};for(let p=0;p<f.length;p++)d[f[p]]=parseFloat(s.fullExtent[f[p]])+l[f[p]];n.extent=d}),y.load().then(()=>{n=new L({container:e,map:y,ui:{components:["attribution"]}});const s=document.getElementsByTagName("geocam-viewer-arcgis-map")[0];s&&s.link&&(console.log("map linking to connector",n),s.link(n));const l=function(d){return d.layers.items.map(p=>p.layers?l(p):p)},f=function(d){return l(d).flat()};n.when(async()=>{window.mv=n;let d=[],p=!1;const V=f(n.map);for(let g=0;g<V.length;g++){const i=V[g];if(await n.whenLayerView(i),i.editingEnabled&&(p=!0),i.fields){const x=i.fields.map(h=>h.name);d.push({layer:i,searchFields:x})}}const P=[];u.forEach((g,i)=>{const x=z[i],h=new x({view:n,container:document.createElement("div"),...c[i].options});P.push(h)}),b.forEach((g,i)=>{if(g==="esri/widgets/Editor"&&!p)return;g==="esri/widgets/Search"&&(o[i].options=o[i].options||{},o[i].options.sources=o[i].options.sources||d);const x=z[i+u.length],h=new x({view:n,container:document.createElement("div"),...o[i].options});console.log("loaded widget",{view:n,container:document.createElement("div"),...o[i].options});const T=new m({view:n,group:"expands",autoCollapse:!0,content:h,expandIconClass:o[i].icon});o[i].watchWidgetFor&&Object.keys(o[i].watchWidgetFor).forEach(S=>{h.watch(S,(...W)=>o[i].watchWidgetFor[S].apply(h,W))}),o[i].watchExpandFor&&Object.keys(o[i].watchExpandFor).forEach(S=>{T.watch(S,(...W)=>o[i].watchExpandFor[S].apply(T,W))}),P.push(T)}),n.ui.add(P,"top-right"),console.log("All widgets added")})}).catch(s=>{var f,d;const l=s&&s.message?(s==null?void 0:s.message)+`
`+((d=(f=s==null?void 0:s.details)==null?void 0:f.error)==null?void 0:d.message):"An unknown erro occurred trying to load the map.";alert(l),console.error("Error loading map:",l)})}),n}class D extends HTMLElement{constructor(){super(),console.log("Map init")}connectedCallback(){console.log("Map connected");const t=this,a=t.getAttribute("webmapid");ne(t,a)}disconnectedCallback(){console.log("labe disconnected")}}window.customElements.define("geocam-map",D),v.GeocamMap=D,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
