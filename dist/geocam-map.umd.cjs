(function(v,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(v=typeof globalThis<"u"?globalThis:v||self,E(v.GeocamMap={}))})(this,function(v){"use strict";var E=typeof window<"u";const G={Promise:E?window.Promise:void 0};var U="4.25",C="next";function q(e){if(e.toLowerCase()===C)return C;var t=e&&e.match(/^(\d)\.(\d+)/);return t&&{major:parseInt(t[1],10),minor:parseInt(t[2],10)}}function R(e){return e===void 0&&(e=U),"https://js.arcgis.com/".concat(e,"/")}function H(e){e===void 0&&(e=U);var t=R(e),r=q(e);if(r!==C&&r.major===3){var n=r.minor<=10?"js/":"";return"".concat(t).concat(n,"esri/css/esri.css")}else return"".concat(t,"esri/themes/light/main.css")}function J(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t}function K(e,t){if(t){var r=document.querySelector(t);r.parentNode.insertBefore(e,r)}else document.head.appendChild(e)}function O(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function X(e){return!e||q(e)?H(e):e}function Z(e,t){var r=X(e),n=O(r);return n||(n=J(r),K(n,t)),n}var _={};function Q(e){var t=document.createElement("script");return t.type="text/javascript",t.src=e,t.setAttribute("data-esri-loader","loading"),t}function $(e,t,r){var n;r&&(n=Y(e,r));var c=function(){t(e),e.removeEventListener("load",c,!1),n&&e.removeEventListener("error",n,!1)};e.addEventListener("load",c,!1)}function Y(e,t){var r=function(n){t(n.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",r,!1)};return e.addEventListener("error",r,!1),r}function N(){return document.querySelector("script[data-esri-loader]")}function F(){var e=window.require;return e&&e.on}function ee(e){e===void 0&&(e={});var t={};[_,e].forEach(function(c){for(var o in c)Object.prototype.hasOwnProperty.call(c,o)&&(t[o]=c[o])});var r=t.version,n=t.url||R(r);return new G.Promise(function(c,o){var u=N();if(u){var b=u.getAttribute("src");b!==n?o(new Error("The ArcGIS API for JavaScript is already loaded (".concat(b,")."))):F()?c(u):$(u,c,o)}else if(F())o(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=t.css;if(i){var p=i===!0;Z(p?r:i,t.insertCssBefore)}u=Q(n),$(u,function(){u.setAttribute("data-esri-loader","loaded"),c(u)},o),document.body.appendChild(u)}})}function j(e){return new G.Promise(function(t,r){var n=window.require.on("error",r);window.require(e,function(){for(var c=[],o=0;o<arguments.length;o++)c[o]=arguments[o];n.remove(),t(c)})})}function te(e,t){if(t===void 0&&(t={}),F())return j(e);var r=N(),n=r&&r.getAttribute("src");return!t.url&&n&&(t.url=n),ee(t).then(function(){return j(e)})}async function ne(e,t){const r={version:"4.26",css:!0};let n;const c=[{name:"Zoom"}],o=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DistanceMeasurement2D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,p,I,w)=>{w.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,p,I,w)=>{i==="measuring"?w.view.emit("clickable",!1):i!=="measuring"&&p==="measuring"&&w.view.emit("clickable",!0),console.log("viewmodel state change",i,w)}}}],u=c?c.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],b=o?o.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await te(["esri/identity/IdentityManager","esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/layers/FeatureLayer"].concat(u).concat(b),r).then(([i,p,I,w,D,...z])=>{window.ARCGIS_TOKEN&&i.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const A=new URLSearchParams(window.location.search),M=A.get("cell"),x=t||A.get("webmapid");let y,k;if(x){const s={id:x};if(x.startsWith("http")){const l=x.split("/");s.id=l.pop();const m=l.join("/"),d=new Portal({url:m});s.portal=d}y=new p({portalItem:s})}else y=new p({basemap:"satellite"});if(M){const s=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/0`;console.log("shots url is",s),k=new D({url:s,definitionExpression:"mod(id,100) = 0"}),y.add(k);const l=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/1`;console.log("points features url is",l);const m=new D({url:l,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});y.add(m)}A.get("zoom")||k&&k.when(s=>{const l={xmin:-.005,ymin:-.005,xmax:.005,ymax:.005},m=Object.keys(l),d={};for(let f=0;f<m.length;f++)d[m[f]]=parseFloat(s.fullExtent[m[f]])+l[m[f]];n.extent=d}),y.load().then(()=>{n=new I({container:e,map:y,ui:{components:["attribution"]}});const s=document.getElementsByTagName("geocam-viewer-arcgis-map")[0];s&&s.link&&(console.log("map linking to connector",n),s.link(n));const l=function(d){return d.layers.items.map(f=>f.layers?l(f):f)},m=function(d){return l(d).flat()};n.when(async()=>{window.mv=n;let d=[],f=!1;const V=m(n.map);for(let g=0;g<V.length;g++){const a=V[g];if(await n.whenLayerView(a),a.editingEnabled&&(f=!0),a.fields){const L=a.fields.map(h=>h.name);d.push({layer:a,searchFields:L})}}const T=[];u.forEach((g,a)=>{const L=z[a],h=new L({view:n,container:document.createElement("div"),...c[a].options});T.push(h)}),b.forEach((g,a)=>{if(g==="esri/widgets/Editor"&&!f)return;g==="esri/widgets/Search"&&(o[a].options=o[a].options||{},o[a].options.sources=o[a].options.sources||d);const L=z[a+u.length],h=new L({view:n,container:document.createElement("div"),...o[a].options});console.log("loaded widget",{view:n,container:document.createElement("div"),...o[a].options});const P=new w({view:n,group:"expands",autoCollapse:!0,content:h,expandIconClass:o[a].icon});o[a].watchWidgetFor&&Object.keys(o[a].watchWidgetFor).forEach(S=>{h.watch(S,(...W)=>o[a].watchWidgetFor[S].apply(h,W))}),o[a].watchExpandFor&&Object.keys(o[a].watchExpandFor).forEach(S=>{P.watch(S,(...W)=>o[a].watchExpandFor[S].apply(P,W))}),T.push(P)}),n.ui.add(T,"top-right"),console.log("All widgets added")})}).catch(s=>{var m,d;const l=s&&s.message?(s==null?void 0:s.message)+`
`+((d=(m=s==null?void 0:s.details)==null?void 0:m.error)==null?void 0:d.message):"An unknown erro occurred trying to load the map.";alert(l),console.error("Error loading map:",l)})}),n}class B extends HTMLElement{constructor(){super(),console.log("Map init")}connectedCallback(){console.log("Map connected");const t=this,r=t.getAttribute("webmapid");ne(t,r)}disconnectedCallback(){console.log("labe disconnected")}}window.customElements.define("geocam-map",B),v.GeocamMap=B,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});
