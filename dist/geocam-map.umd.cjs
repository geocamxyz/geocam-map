(function(v,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(v=typeof globalThis<"u"?globalThis:v||self,E(v.GeocamMap={}))})(this,(function(v){"use strict";var E=typeof window<"u";const G={Promise:E?window.Promise:void 0};var U="4.25",C="next";function q(e){if(e.toLowerCase()===C)return C;var t=e&&e.match(/^(\d)\.(\d+)/);return t&&{major:parseInt(t[1],10),minor:parseInt(t[2],10)}}function R(e){return e===void 0&&(e=U),"https://js.arcgis.com/".concat(e,"/")}function H(e){e===void 0&&(e=U);var t=R(e),r=q(e);if(r!==C&&r.major===3){var n=r.minor<=10?"js/":"";return"".concat(t).concat(n,"esri/css/esri.css")}else return"".concat(t,"esri/themes/light/main.css")}function J(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t}function K(e,t){if(t){var r=document.querySelector(t);r.parentNode.insertBefore(e,r)}else document.head.appendChild(e)}function O(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function X(e){return!e||q(e)?H(e):e}function Z(e,t){var r=X(e),n=O(r);return n||(n=J(r),K(n,t)),n}var _={};function Q(e){var t=document.createElement("script");return t.type="text/javascript",t.src=e,t.setAttribute("data-esri-loader","loading"),t}function $(e,t,r){var n;r&&(n=Y(e,r));var i=function(){t(e),e.removeEventListener("load",i,!1),n&&e.removeEventListener("error",n,!1)};e.addEventListener("load",i,!1)}function Y(e,t){var r=function(n){t(n.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",r,!1)};return e.addEventListener("error",r,!1),r}function N(){return document.querySelector("script[data-esri-loader]")}function F(){var e=window.require;return e&&e.on}function ee(e){e===void 0&&(e={});var t={};[_,e].forEach(function(i){for(var o in i)Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o])});var r=t.version,n=t.url||R(r);return new G.Promise(function(i,o){var d=N();if(d){var b=d.getAttribute("src");b!==n?o(new Error("The ArcGIS API for JavaScript is already loaded (".concat(b,")."))):F()?i(d):$(d,i,o)}else if(F())o(new Error("The ArcGIS API for JavaScript is already loaded."));else{var s=t.css;if(s){var p=s===!0;Z(p?r:s,t.insertCssBefore)}d=Q(n),$(d,function(){d.setAttribute("data-esri-loader","loaded"),i(d)},o),document.body.appendChild(d)}})}function j(e){return new G.Promise(function(t,r){var n=window.require.on("error",r);window.require(e,function(){for(var i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];n.remove(),t(i)})})}function te(e,t){if(t===void 0&&(t={}),F())return j(e);var r=N(),n=r&&r.getAttribute("src");return!t.url&&n&&(t.url=n),ee(t).then(function(){return j(e)})}async function ne(e,t){const r={version:"4.26",css:!0};let n;const i=[{name:"Zoom"}],o=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DistanceMeasurement2D",icon:"esri-icon-measure",watchExpandFor:{expanded:(s,p,I,w)=>{w.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(s,p,I,w)=>{s==="measuring"?w.view.emit("clickable",!1):s!=="measuring"&&p==="measuring"&&w.view.emit("clickable",!0),console.log("viewmodel state change",s,w)}}}],d=i?i.map(s=>s.class?s.class:`esri/widgets/${s.name}`):[],b=o?o.map(s=>s.class?s.class:`esri/widgets/${s.name}`):[];return await te(["esri/identity/IdentityManager","esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/layers/FeatureLayer"].concat(d).concat(b),r).then(([s,p,I,w,D,...z])=>{window.ARCGIS_TOKEN&&s.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const A=new URLSearchParams(window.location.search),M=A.get("cell"),x=t||A.get("webmapid");let y,k;if(x){const c={id:x};if(x.startsWith("http")){const l=x.split("/");c.id=l.pop();const f=l.join("/"),m=new Portal({url:f});c.portal=m}y=new p({portalItem:c})}else y=new p({basemap:"satellite"});if(M){const c=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/0`;console.log("shots url is",c),k=new D({url:c,definitionExpression:"mod(id,100) = 0"}),y.add(k);const l=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/1`;console.log("points features url is",l);const f=new D({url:l,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});y.add(f)}A.get("zoom")||k&&k.when(c=>{const l={xmin:-.005,ymin:-.005,xmax:.005,ymax:.005},f=Object.keys(l),m={};for(let u=0;u<f.length;u++)m[f[u]]=parseFloat(c.fullExtent[f[u]])+l[f[u]];n.extent=m}),y.load().then(()=>{n=new I({container:e,map:y,ui:{components:["attribution"]}});const c=document.getElementsByTagName("geocam-viewer-arcgis-map")[0];c&&c.link&&(console.log("map linking to connector",n),c.link(n));const l=function(m){return m.layers.items.map(u=>u.layers?l(u):u)},f=function(m){return l(m).flat()};n.when(async()=>{window.mv=n;let m=[],u=!1;const V=f(n.map);for(let g=0;g<V.length;g++){const a=V[g];if(await n.whenLayerView(a),a.editingEnabled&&(u=!0),a.fields){const L=a.fields.map(h=>h.name);m.push({layer:a,searchFields:L})}}const T=[];d.forEach((g,a)=>{const L=z[a],h=new L({view:n,container:document.createElement("div"),...i[a].options});T.push(h)}),b.forEach((g,a)=>{if(g==="esri/widgets/Editor"&&!u)return;g==="esri/widgets/Search"&&(o[a].options=o[a].options||{},o[a].options.sources=o[a].options.sources||m);const L=z[a+d.length],h=new L({view:n,container:document.createElement("div"),...o[a].options});console.log("loaded widget",{view:n,container:document.createElement("div"),...o[a].options});const P=new w({view:n,group:"expands",autoCollapse:!0,content:h,expandIconClass:o[a].icon});o[a].watchWidgetFor&&Object.keys(o[a].watchWidgetFor).forEach(S=>{h.watch(S,(...W)=>o[a].watchWidgetFor[S].apply(h,W))}),o[a].watchExpandFor&&Object.keys(o[a].watchExpandFor).forEach(S=>{P.watch(S,(...W)=>o[a].watchExpandFor[S].apply(P,W))}),T.push(P)}),n.ui.add(T,"top-right"),console.log("All widgets added")})}).catch(c=>{const l=c&&c.message?c?.message+`
`+c?.details?.error?.message:"An unknown erro occurred trying to load the map.";alert(l),console.error("Error loading map:",l)})}),n}class B extends HTMLElement{constructor(){super(),console.log("Map init")}connectedCallback(){console.log("Map connected");const t=this,r=t.getAttribute("webmapid");ne(t,r)}disconnectedCallback(){console.log("labe disconnected")}}window.customElements.define("geocam-map",B),v.GeocamMap=B,Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})}));
