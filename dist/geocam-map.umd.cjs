(function(g,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(g=typeof globalThis<"u"?globalThis:g||self,v(g.GeocamMap={}))})(this,function(g){"use strict";var v=typeof window<"u";const W={Promise:v?window.Promise:void 0};var G="4.25",C="next";function U(e){if(e.toLowerCase()===C)return C;var t=e&&e.match(/^(\d)\.(\d+)/);return t&&{major:parseInt(t[1],10),minor:parseInt(t[2],10)}}function q(e){return e===void 0&&(e=G),"https://js.arcgis.com/".concat(e,"/")}function V(e){e===void 0&&(e=G);var t=q(e),r=U(e);if(r!==C&&r.major===3){var n=r.minor<=10?"js/":"";return"".concat(t).concat(n,"esri/css/esri.css")}else return"".concat(t,"esri/themes/light/main.css")}function H(e){var t=document.createElement("link");return t.rel="stylesheet",t.href=e,t}function J(e,t){if(t){var r=document.querySelector(t);r.parentNode.insertBefore(e,r)}else document.head.appendChild(e)}function K(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function O(e){return!e||U(e)?V(e):e}function X(e,t){var r=O(e),n=K(r);return n||(n=H(r),J(n,t)),n}var Z={};function _(e){var t=document.createElement("script");return t.type="text/javascript",t.src=e,t.setAttribute("data-esri-loader","loading"),t}function R(e,t,r){var n;r&&(n=Q(e,r));var s=function(){t(e),e.removeEventListener("load",s,!1),n&&e.removeEventListener("error",n,!1)};e.addEventListener("load",s,!1)}function Q(e,t){var r=function(n){t(n.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",r,!1)};return e.addEventListener("error",r,!1),r}function $(){return document.querySelector("script[data-esri-loader]")}function k(){var e=window.require;return e&&e.on}function Y(e){e===void 0&&(e={});var t={};[Z,e].forEach(function(s){for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=s[o])});var r=t.version,n=t.url||q(r);return new W.Promise(function(s,o){var d=$();if(d){var y=d.getAttribute("src");y!==n?o(new Error("The ArcGIS API for JavaScript is already loaded (".concat(y,")."))):k()?s(d):R(d,s,o)}else if(k())o(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=t.css;if(i){var p=i===!0;X(p?r:i,t.insertCssBefore)}d=_(n),R(d,function(){d.setAttribute("data-esri-loader","loaded"),s(d)},o),document.body.appendChild(d)}})}function N(e){return new W.Promise(function(t,r){var n=window.require.on("error",r);window.require(e,function(){for(var s=[],o=0;o<arguments.length;o++)s[o]=arguments[o];n.remove(),t(s)})})}function ee(e,t){if(t===void 0&&(t={}),k())return N(e);var r=$(),n=r&&r.getAttribute("src");return!t.url&&n&&(t.url=n),Y(t).then(function(){return N(e)})}async function te(e,t){const r={version:"4.26",css:!0};let n;const s=[{name:"Zoom"}],o=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DistanceMeasurement2D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,p,F,w)=>{w.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,p,F,w)=>{i==="measuring"?w.view.emit("clickable",!1):i!=="measuring"&&p==="measuring"&&w.view.emit("clickable",!0),console.log("viewmodel state change",i,w)}}}],d=s?s.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],y=o?o.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await ee(["esri/identity/IdentityManager","esri/WebMap","esri/views/MapView","esri/widgets/Expand","esri/layers/FeatureLayer"].concat(d).concat(y),r).then(([i,p,F,w,B,...D])=>{window.ARCGIS_TOKEN&&i.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const I=new URLSearchParams(window.location.search),M=I.get("cell"),S=t||I.get("webmapid");let E,x;if(S){const c={id:S};if(S.startsWith("http")){const l=S.split("/");c.id=l.pop();const f=l.join("/"),m=new Portal({url:f});c.portal=m}E=new p({portalItem:c})}else E=new p({basemap:"satellite"});if(M){const c=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/0`;console.log("shots url is",c),x=new B({url:c,definitionExpression:"mod(id,100) = 0"}),E.add(x);const l=`${document.location.protocol}//${document.location.host.startsWith("localhost")?"localhost:3092":document.location.host}/arcgis/rest/services/${M}/FeatureServer/1`;console.log("points features url is",l);const f=new B({url:l,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});E.add(f)}I.get("zoom")||x&&x.when(c=>{const l={xmin:-.005,ymin:-.005,xmax:.005,ymax:.005},f=Object.keys(l),m={};for(let u=0;u<f.length;u++)m[f[u]]=parseFloat(c.fullExtent[f[u]])+l[f[u]];n.extent=m}),n=new F({container:e,map:E,ui:{components:["attribution"]}});const T=document.getElementsByTagName("geocam-viewer-arcgis-map")[0];T&&T.link&&(console.log("map linking to connector",n),T.link(n));const z=function(c){return c.layers.items.map(l=>l.layers?z(l):l)},ne=function(c){return z(c).flat()};n.when(async()=>{window.mv=n;let c=[],l=!1;const f=ne(n.map);for(let u=0;u<f.length;u++){const a=f[u];if(await n.whenLayerView(a),a.editingEnabled&&(l=!0),a.fields){const b=a.fields.map(h=>h.name);c.push({layer:a,searchFields:b})}}const m=[];d.forEach((u,a)=>{const b=D[a],h=new b({view:n,container:document.createElement("div"),...s[a].options});m.push(h)}),y.forEach((u,a)=>{if(u==="esri/widgets/Editor"&&!l)return;u==="esri/widgets/Search"&&(o[a].options=o[a].options||{},o[a].options.sources=o[a].options.sources||c);const b=D[a+d.length],h=new b({view:n,container:document.createElement("div"),...o[a].options});console.log("loaded widget",{view:n,container:document.createElement("div"),...o[a].options});const A=new w({view:n,group:"expands",autoCollapse:!0,content:h,expandIconClass:o[a].icon});o[a].watchWidgetFor&&Object.keys(o[a].watchWidgetFor).forEach(L=>{h.watch(L,(...P)=>o[a].watchWidgetFor[L].apply(h,P))}),o[a].watchExpandFor&&Object.keys(o[a].watchExpandFor).forEach(L=>{A.watch(L,(...P)=>o[a].watchExpandFor[L].apply(A,P))}),m.push(A)}),n.ui.add(m,"top-right"),console.log("All widgets added")})}),n}class j extends HTMLElement{constructor(){super(),console.log("Map init")}connectedCallback(){console.log("Map connected");const t=this,r=t.getAttribute("webmapid");te(t,r)}disconnectedCallback(){console.log("labe disconnected")}}window.customElements.define("geocam-map",j),g.GeocamMap=j,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
